
<style>
.am-list>li>a{padding:5px 0px;display:block;float:left;font-weight:bold;width: 120px;margin-left:0px;}
.am-list>li{padding:5px 0 5px 10px;overflow:hidden;}
.am-list>li>div{float:left;overflow:hidden;margin:5px 0px;}
</style>
<div data-am-widget="navbar" class="am-navbar am-cf am-navbar-default am-hide-lg-only"
id="">
  <ul class="am-navbar-nav am-cf am-avg-sm-4">
    <li>
      <a href="<{:U('Index/index')}>">
        <img src="__TMPL__assets/i/icon/087.png"/>
        <span class="am-navbar-label">首页</span>
      </a>
    </li>
    <li style="position: relative;">
      <a href="<{:U('Index/cart')}>">  
	    <span class="am-badge am-badge-warning am-round Allcount" style="position: absolute;left: 50%;top: 2px;margin-left: 5px;">0</span>
        <img src="__TMPL__assets/i/icon/001.png"/>
        <span class="am-navbar-label">购物车</span>
      </a>
    </li>
    <li>
      <a href="<{:U('Index/mlist')}>">  
        <img src="__TMPL__assets/i/icon/093.png"/>
        <span class="am-navbar-label">资讯</span>
      </a>
    </li>
    <li>
      <a href="javascript:void(0)" onclick="login();">
        <img src="__TMPL__assets/i/icon/051.png"/>
        <span class="am-navbar-label">用户</span>
      </a>
    </li>
	<li>
      <a href="<{:U('Index/map')}>">
        <img src="__TMPL__assets/i/icon/118.png"/>
        <span class="am-navbar-label">地图</span>
      </a>
    </li>
  </ul>
</div>
<!--关注我们-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">微信扫一扫
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
      <img src="__TMPL__image/qrcode_for_gh_08d4ac07a642_430.jpg">
    </div>
  </div>
</div>
<!--关注我们结束-->
<!--登陆窗体-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-login">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
      <form class="am-form"  action="<{:U('User/login')}>" method="post" id="loform">
		  <fieldset>
			<legend>会员登陆</legend>
			<div class="am-form-group">
			  <input type="text" class="" placeholder="输入邮箱" name="email">
			</div>
			<div class="am-form-group">
			  <input type="password" class="" placeholder="请输入密码" name="password">
			</div>
			<p><button type="button" class="am-btn am-btn-success am-btn-block" onclick="locheck();">登陆</button></p>
		  </fieldset>
	  </form>
    </div>
  </div>
</div>
<!--登陆结束-->
<!--注册窗体-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-register">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
      <form class="am-form"  action="<{:U('User/register')}>" method="post" id="reform">
		  <fieldset>
			<legend>新用户注册</legend>
			<div class="am-form-group">
			  <input type="text" class="" placeholder="请输入注册邮箱" name="email">
			</div>
			<div class="am-form-group">
			  <input type="password" class="" placeholder="请输入密码" name="password">
			</div>
			<div class="am-form-group">
			  <input type="password" class="" placeholder="请重复输入密码" name="repassword">
			</div>
			<div class="am-form-group">
			  <input type="text" class="" placeholder="输入您的手机号" name="tel">
			</div>
			
			<p><button type="button" class="am-btn am-btn-success am-btn-block" onclick="recheck();">提交</button></p>
		  </fieldset>
	  </form>
    </div>
  </div>
</div>
<!--提交订单-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-account">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
      <form class="am-form"  action="<{:U('order')}>" method="post" id="oform">
		  <fieldset>
			<legend>提交订单</legend>
			<div class="am-form-group">
			  <input type="text" class="" placeholder="输入收货人手机号" name="tel" value="<{$user.tel}>">
			</div>
			<div class="am-form-group">
			  <input type="text" class="" placeholder="输入收货人姓名" name="name" value="<{$user.name}>">
			</div>
			<div class="am-form-group">
			  <input type="text" class="" placeholder="输入收货地址" name="address" value="<{$user.address}>">
			</div>
			<div class="am-form-group">
			  <textarea name="remarks" cols="" rows="" placeholder="送货备注，时间，留言"></textarea>
			</div>
			<input type="hidden" class=""  name="uid" value="<{$user.uid}>">
			<input type="hidden" class=""  name="goods" value="">
			<input type="hidden" class=""  name="totalAmount" value="">
			<input type="hidden" class=""  name="order_no" value="">
			<p><button type="button" class="am-btn am-btn-success am-btn-block" onclick="ocheck();">确认提交</button></p>
		  </fieldset>
	  </form>
    </div>
  </div>
</div>
<!--用户选择窗口-->
<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-User">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
          <p><a type="button" class="am-btn am-btn-secondary am-btn-block" onclick="$('#doc-modal-login').modal('open');$('#doc-modal-User').modal('close');">会员登陆</a></p>
		  <p><a type="button" class="am-btn am-btn-success am-btn-block" onclick="$('#doc-modal-register').modal('open');$('#doc-modal-User').modal('close');">会员注册</a></p>
    </div>
  </div>
</div>
<script>
function login(){
  if('<{$Think.session.uid}>'){
  
  //如果存在session，直接进入后台
  window.location.href="<{:U('User/edit')}>"; 
  }else{
  //弹出窗体，选择登陆还是注册
  
  $('#doc-modal-User').modal('open');
  }
}

function recheck(){
  $email = $("#reform :input[name=email]");
  $mobile = $("#reform :input[name=tel]");
  $password = $("#reform :input[name=password]");
  $confirm_password = $("#reform :input[name=repassword]");
  var submit = false;
  if($email.val()==""){
	 layer.msg("邮箱不能为空");
	 $email.css('border','1px solid #f70b03');
	 return false;
  }
   var email_reg =/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/; 
   if(!email_reg.test($email.val())){ 
      layer.msg("您输入的邮箱有误");
	  $email.css('border','1px solid #f70b03');
	  return false;  
   }
	//还原
  $email.css('border','1px solid #ccc');
  
  if($password.val()==""){
	 layer.msg("密码不能为空");
	 $password.css('border','1px solid #f70b03');
	 return false;
  }
  if($password.val().length < 6){
	 layer.msg("密码不能少于6个字符");
	 $password.css('border','1px solid #f70b03');
	 return false;
  }
  $password.css('border','1px solid #ccc');
  
  if($password.val()!=$confirm_password.val()){
	 layer.msg("两次密码不一致");
	 $confirm_password.css('border','1px solid #f70b03');
	 return false;
  }
  $confirm_password.css('border','1px solid #ccc');
  
  if($mobile.val()==""){
	 layer.msg("手机号不能为空");
	 $mobile.css('border','1px solid #f70b03');
	 return false;
  }
  var mobilereg = /^(((1[3-8]{1}))+\d{9})$/; 
  if(!mobilereg.test($mobile.val())){ 
	  layer.msg("您输入的手机号有误");
	  $mobile.css('border','1px solid #f70b03');
	  return false;
   }
  $mobile.css('border','1px solid #ccc');
  $.post('<{:U("User/checkemail")}>',{email:$email.val()},function(data){
		if(data.status == 1){
			submit = true;
			console.log('1111');
			$("#reform").submit();
		}else{
			$email.css('border','1px solid #f70b03');
			layer.msg(data.info);
		}
  });

 // return false;
  

}
function locheck(){
  if($("#loform :input[name=email]").val()==""){
	 $("#loform :input[name=email]").css('border','1px solid #f70b03');
	 layer.msg("邮箱不能为空");
	 return
  }
  $("#loform :input[name=email]").css('border','1px solid #ccc');
  if($("#loform :input[name=password]").val()==""){
	 $("#loform :input[name=password]").css('border','1px solid #f70b03');
     layer.msg("密码不能为空");
	 return
  }
  $("#loform :input[name=password]").css('border','1px solid #ccc');
  $("#loform").submit();

}
function ocheck(){
  if($("#oform :input[name=tel]").val()==""){
     layer.msg("手机号不能为空");
	 return
  }
  if($("#oform :input[name=name]").val()==""){
     layer.msg("收货人不能为空");
	 return
  }
  if($("#oform :input[name=address]").val()==""){
     layer.msg("收货地址不能为空");
	 return
  }
    var ShoppingCart = utils.getParam("ShoppingCart");
	if(ShoppingCart==null||ShoppingCart==""){
	    layer.msg("没有商品，请先去购物吧！");
	    return
	}else{
		var jsonstr = JSON.parse(ShoppingCart.substr(1,ShoppingCart.length));
		var productlist = jsonstr.productlist;
		orderdetail.totalAmount = jsonstr.totalAmount;	
		if(orderdetail.totalAmount.toFixed(2)<=0){
			layer.msg("没有商品，请先去购物吧！");
	        return
		}else{
			var order_no = new Date().getTime();  
			$("#oform :input[name=order_no]").val(order_no);   //获取一个时间戳作为订单号
			$("#oform :input[name=totalAmount]").val(orderdetail.totalAmount.toFixed(2));   //提交订单总额
			var n = 0 ;
			for(var i=0;i<productlist.length;i++){
				 
				$.post("<{:U('ordergood')}>", { gid: productlist[i].id, num: productlist[i].num ,name:productlist[i].name,price:productlist[i].price,order_no:order_no},function(data)                    {
                    n = n+1;
					if(n==productlist.length){
					    //layer.msg('开始提交');
				    	utils.setParam("ShoppingCart","");
			            car_load();
		            	$("#oform").submit();	
					}
                    } ,'json');	
			}	
		}
	}
}
</script>

<!--购物车处理-->
<script>
$(function(){
//商品减
$(".pd_product-num-minus").click(function(){
  
   var buycount = $('.buycount').html();              // 数量
   if(buycount<=1){
   $('.buycount').html(Number(1));
   }else{
   $('.buycount').html(Number(buycount)-Number(1)); 
   }
});
//商品加
$(".pd_product-num-plus").click(function(){
   var buycount = $('.buycount').html();              // 数量
   $('.buycount').html(Number(buycount)+Number(1)); 
});


//加载购物车
car_load();

});
//清空购物车
$("#delcart").click(function(){
	cart.delcart();
	car_load();//更新购物车
});


//商品详情界面将商品放入购物车
function putCart(){
	var product={
			id:'<{$good.gid}>',    // 商品的ID
			name: '<{$good.name}>',    // 商品名称
			num:$('.buycount').html(),              // 数量
			price:'<{$good.price}>',    // 价格
		};
	var thisTop = $("#img_<{$good.gid}>").offset().top; //所在位置的高度
	var thisLeft = $("#img_<{$good.gid}>").offset().left; //所在位置的宽度
	
	animatenTop(thisTop,thisLeft,'<{$good.gid}>',product);

}

//商品列表界面将商品放入购物车
function addCart(id,name,price){
	var product={
			id:id,    // 商品的ID
			name:name,    // 商品名称
			num:1,              // 数量
			price:price,    // 价格
		};
	var thisTop = $("#img_"+id).offset().top; //所在位置的高度
	var thisLeft = $("#img_"+id).offset().left; //所在位置的宽度

	animatenTop(thisTop,thisLeft,id,product);

}
//购物框标签晃动一下
function shock(){

    var div=$(".Allcount");
    
	div.animate({left:'60%'},100);
    div.animate({left:'50%'},100);
	div.animate({left:'60%'},100);
    div.animate({left:'50%'},100);

}
//修改购物车内的商品
function update(id,num){
    var buycount = $('#'+id).html();              // 数量

    $('#'+id).html(Number(buycount)+Number(num));   //更新购物车里面的数量
    var num = $('#'+id).html();   //获取更新后的
	if(num<=0){
	cart.deleteproduct(id);
	}else{
	cart.updateproductnum(id,num);
	}
	shock();//购物框标签晃动一下
	car_load();//更新购物车
}



function animatenTop(thisTop,thisLeft,menID,product) {
   
    //判断商品图片往哪个方向飞去
	
	var cartLength = $(".am-icon-shopping-cart").offset().left; //取得到购物车的宽度
	if(cartLength>0){
	     //说明是电脑端，选择第一个class
		var cart_direction = $(".Allcount:first");
	}else{
	    var cart_direction = $(".Allcount:last");
	}
	var topLength =  cart_direction.offset().top; //取得到购物车的宽度
    var leftLength = cart_direction.offset().left; //取得到购物车的宽度

    //判断一下当前窗口的宽度是否大于1280px
	var windowwidth  =  $(window).width();
	if(windowwidth>1280){
	   var thisLeft = thisLeft - (windowwidth-1280)/2;
	   var leftLength = leftLength - (windowwidth-1280)/2;
	}
	//获取商品图片的div的宽高
	var width=$(".good_img").width();
	var height=$(".good_img").height();
    var CopyDiv = '<img src="'+$("#img_" + menID).attr("src")+'" id="box" style="top:' + thisTop + 'px;left:' + thisLeft + 'px;z-index:9999;width: '+width+'px;height: '+height+'px"   />';
    
	
    $("body").append(CopyDiv);
	
    $("body").children("#box").animate({width: "30px",height: "30px","top": topLength, "left": leftLength, "opacity": .1  },1000, function(){
	    $(this).remove();
		shock();//购物框标签晃动一下
		cart.addproduct(product);
	    car_load();//更新购物车
    });
    
}
function car_load(){

	var ShoppingCart = utils.getParam("ShoppingCart");
	
	if(ShoppingCart==null||ShoppingCart==""){
		var str='<div style="font-size: 16px;font-weight: bold;text-align: center;color: #009f3c;line-height: 160px;">购物车空空如也</div>';
		$('#totalAmount').html('总计价格：0元');
	}else{
	    var jsonstr = JSON.parse(ShoppingCart.substr(1,ShoppingCart.length));
		var productlist = jsonstr.productlist;
		orderdetail.totalNumber = jsonstr.totalNumber;
		orderdetail.totalAmount = jsonstr.totalAmount;
		var str='';
		for(var i=0;i<productlist.length;i++){
			str+='<li><a href="<{:U("Index/good")}>&gid='+productlist[i].id+'" style="width:140px; overflow:hidden;">'+productlist[i].name.substr(0,9)+'</a><div style="display: -webkit-box;float:right;margin-right:10px;">'+productlist[i].price+'元 x <div class="pd_product-num-wrap"><span class="pd_product-num-minus" onclick="update('+productlist[i].id+',-1)"></span><span class="Number" id="'+productlist[i].id+'">'+productlist[i].num+'</span><span class="pd_product-num-plus" onclick="update('+productlist[i].id+',1)"></span></div></div></li>'; 
		}	
		str+='<li id="Hide" style="text-align:right;padding-right:20px;background-color:#C6F5C6;">总计价格：<span style="color:red; font-weight:bold;font-size:14px;">'+orderdetail.totalAmount.toFixed(2)+'<span>元</li>';
		$('.Allcount').html(orderdetail.totalNumber);
		$('#totalAmount').html('总计价格：<span style="font-weight:bold;">'+orderdetail.totalAmount.toFixed(2)+'<span>元');
	}
	
	$('#cart').html(str);
	
	//onclick="cart.deleteproduct('+productlist[i].id+');"
}


</script>
<footer class="footer am-show-lg-only" style=" width:1244px;margin: 0px auto 0px;">
	<div class="foot_adv">
		<div class="fl"><img src="__TMPL__image/index1.gif"></div>
		<div class="fl"><img src="__TMPL__image/index2.gif"></div>
		<div class="fl"><img src="__TMPL__image/index3.gif"></div>
		<div class="fl"><img src="__TMPL__image/index4.gif"></div>
		<div class="fl"><img src="__TMPL__image/index5.gif"></div>
	</div>
	<div id="powered">

		版权所有 © <{$site_name}> 2016 All Rights Reserved <a href="http://www.miibeian.gov.cn/" target="_blank">京ICP备8888888</a>  <br />
		
	</div>
</footer>
</body>
</html>